@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<ul class="flex items-center gap-2 lg:gap-3 list-none m-0 p-0">
    @if (SignInManager.IsSignedIn(User))
    {
        <!-- Kullanıcı Dropdown Menüsü -->
        <li class="relative">
            <button id="user-menu-button" type="button" class="group flex items-center gap-2 pl-1 pr-1 lg:pl-2 lg:pr-3 py-1 rounded-full hover:bg-gray-100 dark:hover:bg-petrol-800 transition-all duration-300 focus:outline-none ring-offset-2 focus:ring-2 focus:ring-accent-500/50">
                <!-- Avatar -->
                <div class="w-8 h-8 lg:w-9 lg:h-9 rounded-full bg-gradient-to-br from-petrol-600 to-petrol-500 text-white flex items-center justify-center font-bold shadow-md group-hover:shadow-accent-500/30 group-hover:scale-105 transition-all duration-300 border-2 border-white dark:border-petrol-700 text-sm lg:text-base">
                    @User.Identity?.Name?.Substring(0, 1).ToUpper()
                </div>
                <!-- İsim ve İkon (Mobilde gizli, masaüstünde görünür) -->
                <span class="hidden lg:flex items-center text-sm font-bold text-petrol-800 dark:text-gray-200 group-hover:text-accent-500 transition-colors">
                    @User.Identity?.Name
                    <i id="user-menu-icon" class="fas fa-chevron-down ml-2 text-[10px] text-gray-400 group-hover:text-accent-500 transition-transform duration-300"></i>
                </span>
            </button>

            <!-- Dropdown İçerik -->
            <div id="user-dropdown" class="hidden absolute right-0 mt-3 w-64 bg-white/95 dark:bg-petrol-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-100 dark:border-petrol-700 py-2 z-50 origin-top-right transform transition-all duration-200 opacity-0 scale-95">

                <!-- Kullanıcı Başlığı -->
                <div class="px-4 py-3 border-b border-gray-100 dark:border-petrol-700 mb-1">
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Hoş Geldiniz,</p>
                    <p class="text-sm font-bold text-petrol-800 dark:text-white truncate">@User.Identity?.Name</p>
                </div>

                <!-- Menü Linkleri -->
                <div class="px-1 space-y-1">

                    @* 🔐 Panel Bölümü *@
                    @if (User.IsInRole("Admin"))
                    {
                        <a asp-area="Admin" asp-page="/Dashboard/Index"
                           class="group flex items-center px-3 py-2.5 text-sm font-semibold text-petrol-800 dark:text-gray-200 rounded-xl hover:bg-accent-50 dark:hover:bg-petrol-800 hover:text-accent-600 transition-colors">
                            <div class="w-8 h-8 rounded-lg bg-accent-100 dark:bg-petrol-800 flex items-center justify-center mr-3 group-hover:bg-accent-500 group-hover:text-white transition-colors">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            Yönetici Paneli
                        </a>
                    }
                    else
                    {
                        <a asp-area="User" asp-page="/Dashboard/Index"
                           class="group flex items-center px-3 py-2.5 text-sm font-semibold text-petrol-800 dark:text-gray-200 rounded-xl hover:bg-accent-50 dark:hover:bg-petrol-800 hover:text-accent-600 transition-colors">
                            <div class="w-8 h-8 rounded-lg bg-accent-100 dark:bg-petrol-800 flex items-center justify-center mr-3 group-hover:bg-accent-500 group-hover:text-white transition-colors">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            Kullanıcı Paneli
                        </a>
                    }

                    @* Ayırıcı Çizgi *@
                    <div class="my-2 border-t border-gray-200 dark:border-petrol-700"></div>

                    <a asp-area="Identity" asp-page="/Account/Manage/Index" class="group flex items-center px-3 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-petrol-800 hover:text-accent-500 transition-colors">
                        <div class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-petrol-800 flex items-center justify-center mr-3 group-hover:bg-accent-500 group-hover:text-white transition-colors">
                            <i class="fas fa-user-cog"></i>
                        </div>
                        Hesap Ayarları
                    </a>

                    <a href="#" class="group flex items-center px-3 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-petrol-800 hover:text-accent-500 transition-colors">
                        <div class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-petrol-800 flex items-center justify-center mr-3 group-hover:bg-accent-500 group-hover:text-white transition-colors">
                            <i class="fas fa-bell"></i>
                        </div>
                        Bildirimler
                        <span class="ml-auto bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm">3</span>
                    </a>
                </div>

                <div class="border-t border-gray-100 dark:border-petrol-700 my-1"></div>

                <!-- Çıkış -->
                <div class="px-1">
                    <form class="w-full" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })">
                        <button type="submit" class="group w-full flex items-center px-3 py-2.5 text-sm font-bold text-red-600 dark:text-red-400 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                            <div class="w-8 h-8 rounded-lg bg-red-50 dark:bg-red-900/20 flex items-center justify-center mr-3 group-hover:bg-red-500 group-hover:text-white transition-colors">
                                <i class="fas fa-power-off"></i>
                            </div>
                            Güvenli Çıkış
                        </button>
                    </form>
                </div>
            </div>
        </li>

        <!-- Dropdown Logic (Inline Script) -->
        <script>
            (function() {
                const btn = document.getElementById('user-menu-button');
                const menu = document.getElementById('user-dropdown');
                const icon = document.getElementById('user-menu-icon');

                if (btn && menu) {
                    // Menüyü Aç/Kapa
                    const toggleMenu = () => {
                        const isHidden = menu.classList.contains('hidden');

                        if (isHidden) {
                            menu.classList.remove('hidden');
                            // Frame atlaması için minimal timeout ile animasyonu başlat
                            setTimeout(() => {
                                menu.classList.remove('opacity-0', 'scale-95');
                                menu.classList.add('opacity-100', 'scale-100');
                            }, 10);
                            if(icon) icon.classList.add('rotate-180');
                        } else {
                            menu.classList.remove('opacity-100', 'scale-100');
                            menu.classList.add('opacity-0', 'scale-95');
                            setTimeout(() => {
                                menu.classList.add('hidden');
                            }, 200); // transition duration (200ms) ile uyumlu
                            if(icon) icon.classList.remove('rotate-180');
                        }
                    };

                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleMenu();
                    });

                    // Dışarı tıklandığında kapat
                    document.addEventListener('click', (e) => {
                        if (!btn.contains(e.target) && !menu.contains(e.target)) {
                            if (!menu.classList.contains('hidden')) {
                                // Kapatma kodunu tekrarla (DRY için ayrı fonksiyonda tutuldu)
                                menu.classList.remove('opacity-100', 'scale-100');
                                menu.classList.add('opacity-0', 'scale-95');
                                setTimeout(() => {
                                    menu.classList.add('hidden');
                                }, 200);
                                if(icon) icon.classList.remove('rotate-180');
                            }
                        }
                    });
                }
            })();
        </script>
    }
    else
    {
        @* Masaüstü Görünümü (LG ve üzeri) *@
        <li class="hidden lg:block">
            <div class="flex items-center gap-2">
                <a class="group relative inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-petrol-700 dark:text-gray-300 rounded-full transition-all duration-300 hover:text-accent-500 overflow-hidden" asp-area="Identity" asp-page="/Account/Login">
                    <div class="absolute inset-0 bg-accent-500/10 dark:bg-accent-500/15 -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-500 ease-in-out"></div>
                    <i class="fas fa-sign-in-alt text-base relative z-10 transition-transform duration-300 group-hover:translate-x-1"></i>
                    <span class="relative z-10">Giriş</span>
                </a>

                <a class="group relative inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white rounded-full bg-gradient-to-r from-accent-500 to-accent-400 shadow-lg shadow-accent-500/30 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-accent-700/40 overflow-hidden" asp-area="Identity" asp-page="/Account/Register">
                    <div class="absolute inset-0 bg-gradient-to-r from-accent-600 to-accent-700 -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-500 ease-in-out"></div>
                    <i class="fas fa-user-plus text-base relative z-10 transition-transform duration-300 group-hover:translate-x-1"></i>
                    <span class="relative z-10">Kayıt Ol</span>
                </a>
            </div>
        </li>

        @* Mobil Görünümü (LG altı - Sadece İkonlar) *@
        <li class="lg:hidden">
            <div class="flex items-center gap-1">
                <a asp-area="Identity" asp-page="/Account/Login" class="w-9 h-9 flex items-center justify-center rounded-full text-petrol-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-petrol-800 transition-colors" title="Giriş Yap">
                    <i class="fas fa-sign-in-alt text-lg"></i>
                </a>
                <a asp-area="Identity" asp-page="/Account/Register" class="w-9 h-9 flex items-center justify-center rounded-full text-accent-500 hover:bg-accent-50 dark:hover:bg-petrol-800 transition-colors" title="Kayıt Ol">
                    <i class="fas fa-user-plus text-lg"></i>
                </a>
            </div>
        </li>
    }
</ul>